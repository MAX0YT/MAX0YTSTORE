import{initializeApp as _}from"https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";import{getDatabase as $,ref as Q,get as V,child as C}from"https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";import{getAuth as x,createUserWithEmailAndPassword as W,signInWithEmailAndPassword as j,signOut as k,onAuthStateChanged as T,updateProfile as w}from"https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";var z={apiKey:"AIzaSyCUltMwgKS1GOH5sL46f5l0Z9oi6qI2aTI",authDomain:"max0ytst.firebaseapp.com",databaseURL:"https://max0ytst-default-rtdb.firebaseio.com",projectId:"max0ytst",storageBucket:"max0ytst.firebasestorage.app",messagingSenderId:"896428844125",appId:"1:896428844125:web:7a7bed5bfe578785ff59b4",measurementId:"G-G0RDKQBW80"},X=_(z),Y=$(X),A=x(X);class Z{constructor(){document.getElementById("BuyButton").onclick=()=>{this.showPaymentModal()},this.gameData=null,this.currentEmail=null,this.init()}async init(){let F=new URLSearchParams(window.location.search).get("id");if(!F){console.log("Игра не найдена");return}await this.loadGameData(F),this.renderGame()}async loadGameData(q){try{let F=Q(Y,`Games/${q}`),H=await V(F);if(H.exists())this.gameData=H.val(),console.log("Данные игры загружены:",this.gameData);else console.log("Игра не найдена")}catch(F){console.error("Ошибка загрузки данных:",F)}}renderGame(){if(!this.gameData)return;this.updateGameInfo(),this.updateMeta(),this.updatePriceInfo(),this.updateScreenshots(),this.updateBreadcrumbs()}updateGameInfo(){document.getElementById("mainImg").src=this.gameData.images.main,document.getElementById("mainImg").alt=`Купить ${this.gameData.title}`,document.getElementById("secondImg").src=this.gameData.images.main,document.getElementById("secondImg").alt=`Купить ${this.gameData.title}`,document.getElementById("mainTitle").textContent=this.gameData.title,document.getElementById("secondTitle").textContent=this.gameData.title,document.getElementById("description").textContent=this.gameData.description}updateMeta(){let q=document.getElementById("head"),F=document.createElement("meta");F.name="description",F.content=`Купить ${this.gameData.title}. Купить ключ ${this.gameData.title}. Купить ключ игры ${this.gameData.title}. ${this.gameData.title} на пк.`;let H=document.createElement("title");H.textContent=`Купить ключ ${this.gameData.title}`;let J=document.createElement("meta");J.property="og:title",J.content=`Купить ключ ${this.gameData.title} по выгодной цене!`;let L=document.createElement("meta");L.property="og:image",L.content=this.gameData.images.main,q.appendChild(F),q.appendChild(H),q.appendChild(J),q.appendChild(L)}updatePriceInfo(){if(document.getElementById("price").textContent=this.gameData.price+"₽",this.gameData.isDiscount)document.getElementById("discount").textContent=this.gameData.discount+"%",document.getElementById("minusPrice").textContent="-"+this.gameData.price*this.gameData.discount/100+"₽",document.getElementById("finalPrice").textContent=this.gameData.price*(1-this.gameData.discount/100)+"₽";else document.getElementById("discountDiv").remove(),document.getElementById("finalPrice").textContent=this.gameData.price+"₽"}updateScreenshots(){let q=1;while(q<=6){switch(q){case 1:document.getElementById("scr1").src=this.gameData.images.screenshots.s1,document.getElementById("scr1").alt=`Скриншот 1 ${this.gameData.title}.`;break;case 2:document.getElementById("scr2").src=this.gameData.images.screenshots.s2,document.getElementById("scr2").alt=`Скриншот 2 ${this.gameData.title}.`;break;case 3:document.getElementById("scr3").src=this.gameData.images.screenshots.s3,document.getElementById("scr3").alt=`Скриншот 3 ${this.gameData.title}.`;break;case 4:document.getElementById("scr4").src=this.gameData.images.screenshots.s4,document.getElementById("scr4").alt=`Скриншот 4 ${this.gameData.title}.`;break;case 5:document.getElementById("scr5").src=this.gameData.images.screenshots.s5,document.getElementById("scr5").alt=`Скриншот 5 ${this.gameData.title}.`;break;case 6:document.getElementById("scr6").src=this.gameData.images.screenshots.s6,document.getElementById("scr6").alt=`Скриншот 6 ${this.gameData.title}.`;break}q++}}updateBreadcrumbs(){document.getElementById("breadCrumb").textContent=this.gameData.title}showPaymentModal(){this.currentEmail=document.getElementById("email").value.trim();let q=document.getElementById("payment-modal");if(q.classList.remove("hidden"),q.classList.add("flex"),document.getElementById("payment-product-name").textContent=this.gameData.title,document.getElementById("payment-amount").textContent=(1-this.gameData.discount/100)*this.gameData.price+"₽",!window.realStripe.cardElement)alert(1),window.realStripe.initCardElement("#card-element");document.getElementById("confirm-payment").onclick=()=>{this.processStripePayment(this.currentEmail)},document.getElementById("cancel-payment").onclick=()=>{this.hidePaymentModal()}}hidePaymentModal(){let q=document.getElementById("payment-modal");if(q)q.classList.add("hidden"),q.classList.remove("flex");let F=document.getElementById("card-errors");if(F)F.classList.add("hidden"),F.textContent="";this.currentEmail=null}async processStripePayment(q){let F=document.getElementById("card-errors");F.classList.add("hidden");let H=(1-this.gameData.discount/100)*this.gameData.price,J=document.getElementById("confirm-payment"),L=J.textContent;J.textContent="Обработка...",J.disabled=!0;try{let M=await window.realStripe.createPaymentIntent(H*100),K="pi_3PqgKqRx4WEq6RfE1s9t0sQO_secret_Tk4W8W8Z6q8X6q8X6q8X6q8X6q8X6q8X",N=await window.realStripe.confirmPayment("pi_3PqgKqRx4WEq6RfE1s9t0sQO_secret_Tk4W8W8Z6q8X6q8X6q8X6q8X6q8X6q8X");if(N.status==="succeeded")this.handleSuccessfulPayment(q,N);else throw Error("Платеж не прошел. Статус: "+N.status)}catch(M){console.error("Stripe error:",M),F.textContent=this.getFriendlyError(M),F.classList.remove("hidden")}finally{J.textContent=L,J.disabled=!1}}getFriendlyError(q){if(q.message.includes("Недостаточно средств"))return"Недостаточно средств на карте";if(q.message.includes("отклонена"))return"Карта отклонена банком";if(q.message.includes("Срок действия"))return"Срок действия карты истек";return q.message||"Ошибка при обработке платежа"}handleSuccessfulPayment(q,F){this.hidePaymentModal();let H=this.generateGameKey();alert(`✅ Платеж через Stripe успешен!
Транзакция: ${F.id}
Ключ отправлен на: ${q}`),console.log("Stripe Payment Success:",{transactionId:F.id,amount:F.amount/100,email:q,game:this.gameData.title,key:H})}generateGameKey(){let F="";for(let H=0;H<20;H++){if(H>0&&H%5===0)F+="-";F+="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".charAt(Math.floor(Math.random()*36))}return F}}document.addEventListener("DOMContentLoaded",()=>{new Z});
